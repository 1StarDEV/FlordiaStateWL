!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSRPWL - Florida State Roleplay Whitelisted</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #facc15; /* amber-400 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712; /* gray-950 */
            color: #d1d5db; /* gray-300 */
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
        }
        .section-padding {
            padding: 6rem 1rem;
        }
        .text-shadow {
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
        /* Focus state for accessibility */
        :focus-visible {
            outline: 2px solid #fbbf24; /* Tailwind 'amber-400' */
            outline-offset: 2px;
        }

        /* --- Flordiee AI Chat --- */
        #chat-fab {
            transition: all 0.3s ease;
        }

        #chat-window {
            height: 70vh;
            max-height: 700px;
            /* Updated transition for a slight "overshoot" effect */
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: bottom right;
        }

        #chat-window.hidden-chat {
            opacity: 0;
            /* Updated transform */
            transform: translateY(20px) scale(0.9);
            pointer-events: none;
        }

        /* Custom scrollbar */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 10px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #71717a; /* gray-500 */
        }

        /* AI Message basic table styling */
        .ai-message table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
            border: 1px solid #4b5563; /* gray-600 */
        }
        .ai-message th, .ai-message td {
            border: 1px solid #4b5563; /* gray-600 */
            padding: 8px 12px;
            text-align: left;
        }
        .ai-message th {
            background-color: #374151; /* gray-700 */
        }
        .ai-message ul, .ai-message ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
            list-style: revert; /* Re-enabling default list styles */
        }
        .ai-message pre {
            background-color: #1f2937; /* gray-800 */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
        }
        /* Style for inline code */
        .ai-message code:not(pre > code) {
            background-color: #3f3f46; /* gray-700 */
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.85em;
        }
        /* Headings */
        .ai-message h2 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* semibold */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #4b5563; /* gray-600 */
            padding-bottom: 0.25rem;
        }
        .ai-message h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* semibold */
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
        }
        /* Links */
        .ai-message a {
            color: #facc15; /* amber-400 */
            text-decoration: underline;
        }
        .ai-message a:hover {
            color: #fde047; /* amber-300 */
        }

        /* Chat Message Fade-in Animation */
        @keyframes slideFadeIn { 
            0% { opacity: 0; transform: translateY(15px); } 
            100% { opacity: 1; transform: translateY(0); } 
        }
        .message-fade-in {
            animation: slideFadeIn 0.4s ease-out forwards;
        }

    </style>
</head>
<body class="antialiased">

    <!-- Header / Hero Section -->
    <header class="relative overflow-hidden bg-gray-900 border-b border-gray-800">
        <div class="absolute inset-0 z-0 opacity-10" style="background-image: url('https://placehold.co/1920x1080/0d131f/FFFFFF?text=FSRPWL+Background'); background-size: cover; background-position: center;"></div>
        <div class="relative mx-auto container px-4 sm:px-6 lg:px-8 section-padding">
            <div class="text-center">
                <h1 class="text-5xl sm:text-7xl font-extrabold text-white tracking-tight leading-tight text-shadow">
                    Florida State <span class="text-amber-400">Roleplay</span> Whitelisted
                </h1>
                <p class="mt-6 text-xl text-gray-400 max-w-3xl mx-auto">
                    Experience the ultimate realistic roleplay community in Emergency Response: Liberty County. We uphold maturity, structure, and professional standards.
                </p>
                <div class="mt-10 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                    <a href="#departments" class="inline-flex items-center justify-center rounded-md border border-transparent bg-amber-400 px-8 py-3 text-lg font-medium text-gray-900 shadow-xl hover:bg-amber-300 transition duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-950">
                        Join the Community
                    </a>
                    <a href="#rules" class="inline-flex items-center justify-center rounded-md border border-gray-700 bg-gray-800 px-8 py-3 text-lg font-medium text-white shadow-lg hover:bg-gray-700 transition duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-950">
                        View Rules
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- Section 2: Why Choose Us -->
        <section class="section-padding bg-gray-900 border-b border-gray-800">
            <div class="mx-auto container px-4 sm:px-6 lg:px-8">
                <div class="lg:text-center">
                    <h2 class="text-base font-semibold tracking-wide text-amber-400 uppercase">Our Commitment</h2>
                    <p class="mt-2 text-3xl font-bold tracking-tight text-white sm:text-4xl">
                        A New Standard of Roleplay
                    </p>
                    <p class="mt-4 text-xl text-gray-400 lg:mx-auto">
                        FSRPWL offers more than just game time; we offer a career-based, organized, and dedicated experience unlike any other ER:LC group.
                    </p>
                </div>

                <div class="mt-10">
                    <dl class="space-y-10 md:space-y-0 md:grid md:grid-cols-3 md:gap-x-8 md:gap-y-10">
                        <div class="relative">
                            <dt>
                                <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-amber-500 text-white">
                                    <i data-lucide="shield-check" class="h-6 w-6"></i>
                                </div>
                                <p class="ml-16 text-lg leading-6 font-medium text-white">Whitelisted Access</p>
                            </dt>
                            <dd class="mt-2 ml-16 text-base text-gray-400">
                                Ensures every member is screened for maturity and dedication, guaranteeing high-quality roleplay interactions.
                            </dd>
                        </div>

                        <div class="relative">
                            <dt>
                                <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-amber-500 text-white">
                                    <i data-lucide="book-open-text" class="h-6 w-6"></i>
                                </div>
                                <p class="ml-16 text-lg leading-6 font-medium text-white">Structured Training</p>
                            </dt>
                            <dd class="mt-2 ml-16 text-base text-gray-400">
                                Professional, detailed training programs for every department to ensure realistic and consistent operations.
                            </dd>
                        </div>

                        <div class="relative">
                            <dt>
                                <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-amber-500 text-white">
                                    <i data-lucide="users" class="h-6 w-6"></i>
                                </div>
                                <p class="ml-16 text-lg leading-6 font-medium text-white">Dedicated Community</p>
                            </dt>
                            <dd class="mt-2 ml-16 text-base text-gray-400">
                                A supportive, active, and friendly group of mature roleplayers and leaders ready to welcome new members.
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>
        </section>

        <!-- Section 3: Departments -->
        <section id="departments" class="section-padding bg-gray-950 border-b border-gray-800">
            <div class="mx-auto container px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <h2 class="text-base font-semibold tracking-wide text-amber-400 uppercase">Career Paths</h2>
                    <p class="mt-2 text-3xl font-bold tracking-tight text-white sm:text-4xl">
                        Our Core Departments
                    </p>
                    <p class="mt-4 text-lg text-gray-300">
                        Our community is built on structured, realistic departments. Each offers a unique path with dedicated training and leadership.
                    </p>
                </div>
                
                <!-- Department Cards -->
                <div class="mt-12 grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-4">
                    <!-- FHP Card -->
                    <div class="rounded-xl bg-gray-900 p-6 shadow-xl border border-gray-800 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                        <div class="flex flex-col items-center text-center">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-blue-600 text-white mb-4">
                                <i data-lucide="car" class="h-8 w-8"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white">Florida Highway Patrol</h3>
                            <p class="mt-2 text-gray-400 text-sm">
                                High-speed pursuit operations and interstate traffic enforcement. The backbone of state-wide law enforcement.
                            </p>
                            <a href="#" class="mt-4 text-amber-400 hover:text-amber-300 text-sm font-medium transition duration-200">
                                Learn More &rarr;
                            </a>
                        </div>
                    </div>
                    <!-- Sheriff Card -->
                    <div class="rounded-xl bg-gray-900 p-6 shadow-xl border border-gray-800 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                        <div class="flex flex-col items-center text-center">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-red-600 text-white mb-4">
                                <i data-lucide="building-2" class="h-8 w-8"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white">Sheriff's Office</h3>
                            <p class="mt-2 text-gray-400 text-sm">
                                Primary jurisdiction across the county, handling patrols, investigations, and community policing.
                            </p>
                            <a href="#" class="mt-4 text-amber-400 hover:text-amber-300 text-sm font-medium transition duration-200">
                                Learn More &rarr;
                            </a>
                        </div>
                    </div>
                    <!-- Fire & Rescue Card -->
                    <div class="rounded-xl bg-gray-900 p-6 shadow-xl border border-gray-800 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                        <div class="flex flex-col items-center text-center">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-green-600 text-white mb-4">
                                <i data-lucide="syringe" class="h-8 w-8"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white">Fire & Rescue</h3>
                            <p class="mt-2 text-gray-400 text-sm">
                                Responding to medical emergencies, fire suppression, and complex rescue operations.
                            </p>
                            <a href="#" class="mt-4 text-amber-400 hover:text-amber-300 text-sm font-medium transition duration-200">
                                Learn More &rarr;
                            </a>
                        </div>
                    </div>
                    <!-- Comms Card -->
                    <div class="rounded-xl bg-gray-900 p-6 shadow-xl border border-gray-800 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                        <div class="flex flex-col items-center text-center">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-yellow-600 text-gray-900 mb-4">
                                <i data-lucide="radio" class="h-8 w-8"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white">Communications</h3>
                            <p class="mt-2 text-gray-400 text-sm">
                                The vital link between citizens and first responders, managing calls and coordinating units efficiently.
                            </p>
                            <a href="#" class="mt-4 text-amber-400 hover:text-amber-300 text-sm font-medium transition duration-200">
                                Learn More &rarr;
                            </a>
                        </div>
                    </div>
                </div>

                <!-- --- âœ¨ New Gemini Feature: Scenario Generator --- -->
                <div class="mt-24 max-w-4xl mx-auto">
                    <div class="text-center">
                        <h3 class="text-3xl font-bold tracking-tight text-white flex items-center justify-center">
                            <i data-lucide="sparkles" class="h-6 w-6 text-amber-400 mr-3"></i>
                            Test Your RP Skills
                        </h3>
                        <p class="mt-4 text-lg text-gray-300">
                            Want to see if you're a good fit? Select a department and let our AI generate a realistic scenario for you to handle.
                        </p>
                    </div>

                    <div class="mt-10 flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                        <select id="scenario-select" class="flex-1 bg-gray-800 border border-gray-700 rounded-md px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                            <option value="">-- Select a Department --</option>
                            <option value="Florida Highway Patrol">Florida Highway Patrol</option>
                            <option value="Sheriff's Office">Sheriff's Office</option>
                            <option value="Fire & Rescue">Fire & Rescue</option>
                            <option value="Communications">Communications</option>
                        </select>
                        <button id="scenario-button" class="rounded-md bg-amber-400 px-8 py-3 text-lg font-medium text-gray-900 shadow-lg hover:bg-amber-300 transition duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900">
                            Generate Scenario
                        </button>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="scenario-loading" class="hidden mt-6 flex items-center justify-center space-x-2">
                        <div class="h-2 w-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay: -0.3s;"></div>
                        <div class="h-2 w-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay: -0.15s;"></div>
                        <div class="h-2 w-2 bg-amber-400 rounded-full animate-bounce"></div>
                        <span class="text-sm text-gray-400">Generating scenario...</span>
                    </div>

                    <!-- Result Box -->
                    <div id="scenario-result" class="hidden mt-6 rounded-lg bg-gray-800 p-6 border border-gray-700 ai-message">
                        <h4 class="text-lg font-semibold text-white mb-3">Generated Scenario:</h4>
                        <p id="scenario-result-text" class="text-gray-300 leading-relaxed"></p>
                    </div>
                </div>
                <!-- --- End New Gemini Feature --- -->

            </div>
        </section>

        <!-- Section 4: Rules -->
        <section id="rules" class="section-padding bg-gray-900">
            <div class="mx-auto container px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <h2 class="text-base font-semibold tracking-wide text-amber-400 uppercase">Integrity First</h2>
                    <p class="mt-2 text-3xl font-bold tracking-tight text-white sm:text-4xl">
                        Core Community Rules
                    </p>
                    <p class="mt-4 text-xl text-gray-400 lg:mx-auto">
                        Maturity and realism are mandatory. We enforce a strict set of rules to maintain a professional environment.
                    </p>
                </div>

                <div class="mt-10 max-w-4xl mx-auto">
                    <ul role="list" class="space-y-4">
                        <li class="p-4 bg-gray-800 rounded-lg shadow-md flex items-start space-x-3 border border-gray-700">
                            <i data-lucide="user-x" class="h-6 w-6 text-red-500 flex-shrink-0"></i>
                            <p class="text-base text-gray-300">
                                <strong class="text-white">No Random Deathmatch (RDM) / Vehicle Deathmatch (VDM):</strong> Killing players or running them over without a valid, in-character roleplay reason will result in an immediate ban.
                            </p>
                        </li>
                        <li class="p-4 bg-gray-800 rounded-lg shadow-md flex items-start space-x-3 border border-gray-700">
                            <i data-lucide="gavel" class="h-6 w-6 text-amber-400 flex-shrink-0"></i>
                            <p class="text-base text-gray-300">
                                <strong class="text-white">Strict Chain of Command:</strong> All members must respect and follow the instructions of their commanding officers and department leadership.
                            </p>
                        </li>
                        <li class="p-4 bg-gray-800 rounded-lg shadow-md flex items-start space-x-3 border border-gray-700">
                            <i data-lucide="mic" class="h-6 w-6 text-green-500 flex-shrink-0"></i>
                            <p class="text-base text-gray-300">
                                <strong class="text-white">Realistic Radio Communication:</strong> Use proper 10-codes and clear, concise language over in-game and Discord communications.
                            </p>
                        </li>
                        <li class="p-4 bg-gray-800 rounded-lg shadow-md flex items-start space-x-3 border border-gray-700">
                            <i data-lucide="clock" class="h-6 w-6 text-blue-500 flex-shrink-0"></i>
                            <p class="text-base text-gray-300">
                                <strong class="text-white">Age/Maturity Requirement:</strong> Applicants must be 16+ years of age and demonstrate high levels of maturity during the application and interview process.
                            </p>
                        </li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-950 border-t border-gray-800">
        <div class="mx-auto container px-4 sm:px-6 lg:px-8 py-8 text-center text-gray-500">
            <p>&copy; 2024 FSRPWL Community. All rights reserved. | Unofficial Roblox ER:LC Roleplay Group</p>
        </div>
    </footer>

    <!-- Flordiee AI Chatbot FAB -->
    <button id="chat-fab" class="fixed bottom-6 right-6 p-4 rounded-full bg-amber-500 text-gray-900 shadow-2xl hover:bg-amber-400 transition duration-300 focus:outline-none focus-visible:ring-4 focus-visible:ring-amber-500 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-950 z-50">
        <i data-lucide="message-square" class="h-6 w-6"></i>
    </button>

    <!-- Chat Window -->
    <div id="chat-window" class="hidden-chat fixed bottom-20 right-6 w-full max-w-sm bg-gray-900 rounded-xl shadow-2xl flex flex-col border border-gray-700 z-50">
        <!-- Chat Header -->
        <div class="p-4 flex justify-between items-center border-b border-gray-800 bg-gray-800 rounded-t-xl">
            <div class="flex items-center space-x-2">
                <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </span>
                <span class="text-lg font-semibold text-white">Flordiee AI</span>
            </div>
            <button id="close-btn" class="p-1 rounded-full text-gray-400 hover:text-white hover:bg-gray-700 transition duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400">
                <i data-lucide="x" class="h-5 w-5"></i>
            </button>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Messages go here -->
        </div>

        <!-- Loading Indicator -->
        <div id="chat-loading" class="hidden p-4 border-t border-gray-700">
            <div class="flex items-center space-x-2">
                <div class="h-2 w-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay: -0.3s;"></div>
                <div class="h-2 w-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay: -0.15s;"></div>
                <div class="h-2 w-2 bg-amber-400 rounded-full animate-bounce"></div>
                <span class="text-sm text-gray-400">Flordiee is searching...</span>
            </div>
        </div>

        <!-- Input Form -->
        <form id="chat-form" class="p-4 border-t border-gray-700">
            <div class="flex space-x-3">
                <input type="text" id="chat-input" placeholder="Ask Flordiee a question..." class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                <button type="submit" id="send-btn" class="p-3 rounded-lg bg-amber-500 text-gray-900 hover:bg-amber-400 transition duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900">
                    <i data-lucide="send" class="h-5 w-5"></i>
                </button>
            </div>
        </form>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', (event) => {
            // --- Chat UI Elements ---
            const chatFab = document.getElementById('chat-fab');
            const chatWindow = document.getElementById('chat-window');
            const closeBtn = document.getElementById('close-btn');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');
            const chatLoading = document.getElementById('chat-loading');

            // --- New Scenario Generator Elements ---
            const scenarioSelect = document.getElementById('scenario-select');
            const scenarioButton = document.getElementById('scenario-button');
            const scenarioLoading = document.getElementById('scenario-loading');
            const scenarioResult = document.getElementById('scenario-result');
            const scenarioResultText = document.getElementById('scenario-result-text');


            // --- Chat State ---
            let isChatOpen = false;
            let messages = [
                {
                    role: 'ai',
                    text: "Hello! I'm Flordiee AI, your assistant for the FSRPWL community. How can I help you today?",
                    sources: [] // Add sources array
                }
            ];

            // --- Gemini API Configuration ---
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const chatSystemPrompt = "You are Flordiee AI, a helpful and professional assistant for the FSRPWL (Florida State Roleplay Whitelisted) community. You are friendly and knowledgeable. You MUST use your Google Search tool to find information about FSRPWL, Roblox, ER:LC, or any current events. You MUST format your answers with Markdown (headings, lists, **bold**, *italic*, tables, `code`, and links).";

            // --- Functions ---
            
            /**
             * Toggles the chat window open/closed
             */
            function toggleChat() {
                isChatOpen = !isChatOpen;
                if (isChatOpen) {
                    chatWindow.classList.remove('hidden-chat');
                    chatFab.classList.add('opacity-0', 'scale-0');
                    // Scroll to bottom when opening
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    chatWindow.classList.add('hidden-chat');
                    chatFab.classList.remove('opacity-0', 'scale-0');
                }
            }
            
            /**
             * NEW Robust Markdown to HTML converter
             * Supports: headings, tables, lists, code blocks, links, bold, italic, inline code
             */
            function parseMarkdown(text) {
                if (typeof text !== 'string' || !text) {
                    return ''; // Return empty string if text is not a valid string
                }

                let html = text;

                // 1. Code Blocks (```...```)
                html = html.replace(/```([\s\S]*?)```/g, (match, p1) => {
                    const codeContent = (p1 || '').trim();
                    const escapedCode = codeContent.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    return `<pre><code>${escapedCode}</code></pre>`;
                });

                // 2. Headings (#, ##, ###)
                html = html.replace(/^## (.*$)/gim, '<h3>$1</h3>');
                html = html.replace(/^# (.*$)/gim, '<h2>$1</h2>');

                // 3. Tables (Block)
                html = html.replace(/^((?:\|.*\|\s*\n)+)(?!\|)/gm, (match) => {
                    const lines = (match || '').trim().split('\n');
                    if (lines.length < 2) return match; // Not a table

                    const tableLines = lines.filter(line => line.startsWith('|'));
                    if (tableLines.length < 2) return match; // Not a table
                    
                    // Check for separator
                    if (!tableLines[1].match(/\|( *[-:]+ *\|)+/)) return match; 

                    let table = '<table>';
                    
                    // Header
                    table += '<thead><tr>';
                    (tableLines[0] || '').trim().split('|').filter(Boolean).forEach(th => {
                        table += `<th>${(th || '').trim()}</th>`;
                    });
                    table += '</tr></thead>';
                    
                    // Body
                    table += '<tbody>';
                    tableLines.slice(2).forEach(line => {
                        table += '<tr>';
                        (line || '').trim().split('|').filter(Boolean).forEach(td => {
                            table += `<td>${(td || '').trim()}</td>`;
                        });
                        table += '</tr>';
                    });
                    table += '</tbody></table>';
                    return table;
                });

                // 4. Unordered Lists (Block)
                html = html.replace(/^((?:\s*-\s+.*\n?)+)/gm, (match) => {
                    const items = (match || '').trim().split('\n');
                    let list = '<ul>';
                    items.forEach(item => {
                        list += `<li>${(item || '').replace(/^\s*-\s+/, '').trim()}</li>`;
                    });
                    list += '</ul>';
                    return list;
                });

                // 5. Ordered Lists (Block)
                html = html.replace(/^((?:\s*\d+\.\s+.*\n?)+)/gm, (match) => {
                    const items = (match || '').trim().split('\n');
                    let list = '<ol>';
                    items.forEach(item => {
                        list += `<li>${(item || '').replace(/^\s*\d+\.\s+/, '').trim()}</li>`;
                    });
                    list += '</ol>';
                    return list;
                });

                // 6. Links ([text](url))
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

                // 7. Bold (**)
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                // 8. Italic (*)
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

                // 9. Inline Code (`)
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

                // 10. Newlines
                // Avoid replacing newlines inside <pre> or list items just created
                // We'll rely on CSS 'white-space: pre-wrap' for the message blocks,
                // but replace double newlines with paragraphs
                html = html.split(/\n\s*\n/).map(p => p.trim() ? `<p>${p}</p>` : '').join('')
                    .replace(/<p><table>/g, '<table>') // Fix paragraph around table
                    .replace(/<\/table><\/p>/g, '</table>')
                    .replace(/<p><ul>/g, '<ul>') // Fix paragraph around lists
                    .replace(/<\/ul><\/p>/g, '</ul>')
                    .replace(/<p><ol>/g, '<ol>')
                    .replace(/<\/ol><\/p>/g, '</ol>')
                    .replace(/<p><pre>/g, '<pre>') // Fix paragraph around code
                    .replace(/<\/pre><\/p>/g, '</pre>')
                    .replace(/<p><h2>/g, '<h2>') // Fix paragraph around headings
                    .replace(/<\/h2><\/p>/g, '</h2>')
                    .replace(/<p><h3>/g, '<h3>')
                    .replace(/<\/h3><\/p>/g, '</h3>')
                    .replace(/\n/g, '<br>'); // Convert remaining newlines
                
                return html.replace(/<p><br><\/p>/g, ''); // Clean up empty paragraphs
            }


            /**
             * Renders the current 'messages' array to the chat window
             */
            function renderMessages() {
                chatMessages.innerHTML = ''; // Clear existing messages
                messages.forEach(message => {
                    const messageEl = document.createElement('div');
                    messageEl.classList.add('flex', 'flex-col', 'max-w-[85%]', 'rounded-lg', 'px-4', 'py-2', 'message-fade-in');

                    if (message.role === 'user') {
                        messageEl.classList.add('bg-amber-400', 'text-gray-900', 'self-end', 'rounded-br-none');
                        // Use textContent for user messages to prevent XSS
                        messageEl.textContent = message.text;
                    } else {
                        messageEl.classList.add('bg-gray-800', 'text-white', 'self-start', 'rounded-bl-none', 'ai-message');
                        
                        // Render main message content
                        const contentEl = document.createElement('div');
                        contentEl.innerHTML = parseMarkdown(message.text);
                        messageEl.appendChild(contentEl);

                        // Render sources if they exist
                        if (message.sources && message.sources.length > 0) {
                            const sourcesEl = document.createElement('div');
                            sourcesEl.classList.add('mt-3', 'pt-3', 'border-t', 'border-gray-700');
                            
                            const sourcesTitle = document.createElement('h4');
                            sourcesTitle.classList.add('text-xs', 'font-semibold', 'text-gray-400', 'mb-1', 'uppercase');
                            sourcesTitle.textContent = 'Sources:';
                            sourcesEl.appendChild(sourcesTitle);
                            
                            const sourcesList = document.createElement('ul');
                            sourcesList.classList.add('space-y-1');
                            
                            message.sources.forEach((source, index) => {
                                const sourceItem = document.createElement('li');
                                sourceItem.classList.add('text-xs', 'truncate');
                                
                                const sourceLink = document.createElement('a');
                                sourceLink.href = source.uri;
                                sourceLink.target = '_blank';
                                sourceLink.rel = 'noopener noreferrer';
                                sourceLink.classList.add('text-amber-400', 'hover:text-amber-300', 'hover:underline');
                                sourceLink.innerHTML = `<i data-lucide="link-2" class="h-3 w-3 inline-block mr-1"></i> ${source.title || source.uri}`;
                                
                                sourceItem.appendChild(sourceLink);
                                sourcesList.appendChild(sourceItem);
                            });
                            
                            sourcesEl.appendChild(sourcesList);
                            messageEl.appendChild(sourcesEl);
                            // Re-run lucide icons for the new source icons
                            lucide.createIcons();
                        }
                    }
                    chatMessages.appendChild(messageEl);
                });
                                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
 
            /**
              * Shows or hides the chat loading indicator
              * @param {boolean} isLoading
              */
            function setChatLoading(isLoading) {
                if (isLoading) {
                    chatLoading.classList.remove('hidden');
                } else {
                    chatLoading.classList.add('hidden');
                }
            }

            /**
             * Shows or hides the scenario loading indicator
             * @param {boolean} isLoading
             */
            function setScenarioLoading(isLoading) {
                if (isLoading) {
                    scenarioLoading.classList.remove('hidden');
                    scenarioResult.classList.add('hidden'); // Hide old result
                } else {
                    scenarioLoading.classList.add('hidden');
                }
            }
            
            /**
             * Gemini API call function for CHAT (with grounding)
             * @param {string} userQuery
             * @param {string} systemPrompt
             * @param {number} retryDelay - Initial retry delay in ms
             * @param {number} maxRetries - Max number of retries
             * @returns {Promise<{text: string|null, sources: Array}>} - The AI's response
             */
            async function callGeminiChatAPI(userQuery, systemPrompt, retryDelay = 1000, maxRetries = 3) {
                const payload = {
                    contents: [
                        { parts: [{ text: userQuery }] }
                    ],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    // Enable Google Search grounding
                    tools: [{ "google_search": {} }], 
                };
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && maxRetries > 0) { // Throttling
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                            return callGeminiChatAPI(userQuery, systemPrompt, retryDelay * 2, maxRetries - 1);
                        }
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const aiText = candidate?.content?.parts?.[0]?.text;
                    let sources = [];

                    // Extract grounding sources
                    const groundingMetadata = candidate?.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => ({
                                uri: attr.web?.uri,
                                title: attr.web?.title,
                            }))
                            .filter(source => source.uri); // Only keep valid sources
                    }

                    if (aiText) {
                        return { text: aiText, sources: sources };
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return { text: null, sources: [] }; // Return null on failure
                }
            }

            /**
             * Gemini API call function for CREATIVE (no grounding)
             * @param {string} userQuery
             * @param {string} systemPrompt
             * @param {number} retryDelay - Initial retry delay in ms
             * @param {number} maxRetries - Max number of retries
             * @returns {Promise<{text: string|null, sources: Array}>} - The AI's response
             */
            async function callGeminiCreativeAPI(userQuery, systemPrompt, retryDelay = 1000, maxRetries = 3) {
                const payload = {
                    contents: [
                        { parts: [{ text: userQuery }] }
                    ],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    // NO tools property, as we don't want grounding
                };
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && maxRetries > 0) { // Throttling
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                            return callGeminiCreativeAPI(userQuery, systemPrompt, retryDelay * 2, maxRetries - 1);
                        }
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (aiText) {
                        return { text: aiText, sources: [] }; // Return with empty sources
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return { text: null, sources: [] }; // Return null on failure
                }
            }
            
            /**
             * Handles the CHAT message send
             * @param {Event} e
             */
            async function handleMessageSend(e) {
                e.preventDefault();
                const userQuery = chatInput.value.trim();
                if (!userQuery) return;

                // Add user message to state and render
                messages.push({ role: 'user', text: userQuery, sources: [] });
                renderMessages();
                chatInput.value = '';
                
                // Show loading and call API
                setChatLoading(true);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll down to show loading
                
                // Use the new CHAT-specific API call
                const { text, sources } = await callGeminiChatAPI(userQuery, chatSystemPrompt);
                
                if (text) {
                    messages.push({ role: 'ai', text: text, sources: sources });
                } else {
                    messages.push({ role: 'ai', text: "Sorry, I seem to be having trouble connecting. Please try again in a moment.", sources: [] });
                }
                
                setChatLoading(false);
                renderMessages();
            }

            /**
             * Handles the SCENARIO GENERATOR button click
             */
            async function handleScenarioGenerate() {
                const selectedDepartment = scenarioSelect.value;
                if (!selectedDepartment) {
                    scenarioResultText.innerHTML = parseMarkdown("*Please select a department first.*");
                    scenarioResult.classList.remove('hidden');
                    return;
                }

                setScenarioLoading(true);

                const scenarioSystemPrompt = "You are a creative director for a realistic, mature, whitelist-only roleplay community (FSRPWL). Your job is to generate engaging, serious, and realistic scenario prompts for players. The prompts must be concise (about 100 words), require thoughtful decision-making, and be suitable for a mature audience. Format as a single paragraph with Markdown if needed.";
                const scenarioQuery = `Generate a short, realistic roleplay scenario for the "${selectedDepartment}" department in Emergency Response: Liberty County.`;
                
                // Use the new CREATIVE-specific API call
                const { text } = await callGeminiCreativeAPI(scenarioQuery, scenarioSystemPrompt);
                
                setScenarioLoading(false);
                
                if (text) {
                    scenarioResultText.innerHTML = parseMarkdown(text);
                } else {
                    scenarioResultText.innerHTML = parseMarkdown("Sorry, I had an error generating a scenario. Please try again in a moment.");
                }
                scenarioResult.classList.remove('hidden');
            }


            // --- Event Listeners ---
            chatFab.addEventListener('click', toggleChat);
            closeBtn.addEventListener('click', toggleChat);
            chatForm.addEventListener('submit', handleMessageSend);
            scenarioButton.addEventListener('click', handleScenarioGenerate); // New listener
            
            // --- Initial Render ---
            renderMessages();

            // Initial icon rendering
            lucide.createIcons();
        });
    </script>
</body>
</html>
